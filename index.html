<!-- https://www.ag-grid.com/javascript-data-grid/getting-started/ -->
<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
  <script src="https://cdn.anychart.com/releases/8.0.0/js/anychart-base.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-pie.min.js"></script>
  <script type="text/javascript" src="orderBookData.JSON"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-alpine.css">
</head>
<body>
  <h1 >Orderbooks</h1>
  <div style="margin-left: auto; margin-right: auto; width: 100%">
    <div id="eth_usdt_grid" style="height: 600px;width:500px; display: inline-block;" class="ag-theme-alpine"></div>
    <div id="usdt_eth_grid" style="height: 600px;width:500px; display: inline-block;" class="ag-theme-alpine"></div>
  </div>
  <div>
    <div id="eth_btc_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
    <div id="btc_eth_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
  </div>
  <div>
    <div id="eth_bnb_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
    <div id="bnb_eth_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
  </div>
  <div>
    <div id="bnb_btc_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
    <div id="btc_bnb_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
  </div>
  <div>
    <div id="bnb_usdt_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
    <div id="usdt_bnb_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
  </div>
  <div>
    <div id="usdt_btc_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
    <div id="btc_usdt_grid" style="height: 600px;width:600px; display: inline-block;" class="ag-theme-alpine"></div>
  </div>

  <div id="wealth_bar_chart" style="width: 100%; height: 300px"></div>
  <div id="tooltip" class="custom-tooltip"></div>

  <div id="distribution_pie_chart" style="width: 100%; height: 700px; margin: 0; padding: 0"></div>

  <div id="transactions_line_chart" style="width: 100%; height: 700px; margin: 0; padding: 0"></div>

  <script type="text/javascript" charset="utf-8">

    const testData = {"ETH/USDT:USDT/ETH": {"ETH/USDT": {"0": {"amount": 27, "limit_price": 127, "exchange_price": 0.0027}, "1": {"amount": 13046.074985975187, "limit_price": 130.46174985975188, "exchange_price": 0.007665081919221637}}, "USDT/ETH": {"0": {"amount": 13046.074985975187, "limit_price": 130.46174985975188, "exchange_price": 0.007665081919221637}, "1": {"amount": 13046.074985975187, "limit_price": 130.46174985975188, "exchange_price": 0.007665081919221637}}}, "ETH/BNB:BNB/ETH": {"ETH/BNB": {}, "BNB/ETH": {}}, "ETH/BTC:BTC/ETH": {"ETH/BTC": {}, "BTC/ETH": {}}, "BNB/BTC:BTC/BNB": {"BNB/BTC": {}, "BTC/BNB": {}}, "BNB/USDT:USDT/BNB": {"BNB/USDT": {}, "USDT/BNB": {"0": {"amount": 1372.3055568517361, "limit_price": 13.724055568517361, "exchange_price": 0.07286475889051156}}}, "BTC/USDT:USDT/BTC": {"BTC/USDT": {}, "USDT/BTC": {}}}

    const url_for_orderbook = new URL("http://localhost:5000")
    fetch(url_for_orderbook)
        .then(response=>response.json())
        .then(data => orderbookData = data)
        .then((orderBookData) => createAnOrderBookTable(orderbookData["ETH/USDT:USDT/ETH"]["USDT/ETH"], "USDT/ETH", "usdt_eth_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["ETH/USDT:USDT/ETH"]["ETH/USDT"], "ETH/USDT", "eth_usdt_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["ETH/BTC:BTC/ETH"]["ETH/BTC"], "ETH/BTC", "eth_btc_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["ETH/BTC:BTC/ETH"]["BTC/ETH"], "BTC/ETH", "btc_eth_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["ETH/BNB:BNB/ETH"]["ETH/BNB"], "ETH/BNB", "eth_bnb_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["ETH/BNB:BNB/ETH"]["BNB/ETH"], "BNB/ETH", "bnb_eth_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["BNB/BTC:BTC/BNB"]["BNB/BTC"], "BNB/BTC", "bnb_btc_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["BNB/BTC:BTC/BNB"]["BTC/BNB"], "BTC/BNB", "btc_bnb_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["BNB/USDT:USDT/BNB"]["BNB/USDT"], "BNB/USDT", "bnb_usdt_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["BNB/USDT:USDT/BNB"]["USDT/BNB"], "USDT/BNB", "usdt_bnb_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["BTC/USDT:USDT/BTC"]["BTC/USDT"], "BTC/USDT", "btc_usdt_grid"))
        .then((orderBookData) => createAnOrderBookTable(orderbookData["BTC/USDT:USDT/BTC"]["USDT/BTC"], "USDT/BTC", "usdt_btc_grid"))
        .then ( () => console.log("done second one"))

    const url_for_transaction_data = new URL("http://localhost:5000/transactions")
    fetch(url_for_transaction_data)
        .then(response => response.json())
        .then(data => makeTransactionNumbersGraph(data))
        .then(console.log("yeahllhoe"))

    const url_for_wealth_distribution_data = new URL("http://localhost:5000/distribution")
    fetch(url_for_wealth_distribution_data)
        .then(response => response.json())
        .then(data => makeWealthDistributionPieChart(data))

    const url_for_wealthiest_agents_data = new URL("http://localhost:5000/wealth")
    fetch(url_for_wealthiest_agents_data)
        .then(response => response.json())
        .then(data => makeWealthyAgentsBarChart(data))

    function createAnOrderBookTable(data, exchange_symbol, grid_id) {
        var direction_data = data
        let field_name_amount = "amount_" + exchange_symbol
        let field_name_exchange_price = "exchange_price_" + exchange_symbol
        let field_name_limit_price = "limit_price_" + exchange_symbol
        let data_rows = []
        for (let j = 0; j < 100; j++) {
            let row = {}
            if (direction_data[j] == null) { break }
            field_name_amount = "amount_" + exchange_symbol
            field_name_exchange_price = "exchange_price_" + exchange_symbol
            field_name_limit_price = "limit_price_" + exchange_symbol

            row[field_name_amount] = direction_data[j]['amount']
            row[field_name_exchange_price] = direction_data[j]['exchange_price']
            row[field_name_limit_price] = direction_data[j]['limit_price']
            data_rows.push(row)
        }

        var eGridDiv = document.querySelector("#" + grid_id);
        var gridOptions = {
            columnDefs: [ { headerName: exchange_symbol, children: [
                            { headerName: "Amount", field: field_name_amount },
                            { headerName: "Exchange Price", field: field_name_exchange_price },
                            { headerName: "Limit Price", field: field_name_limit_price }]
                    },]};
        new agGrid.Grid(eGridDiv, gridOptions);
        gridOptions.api.setRowData(data_rows);
    }

    function makeTransactionNumbersGraph(data){
        let name = "num_transactions_"
        let row_data_0 = []
        let row_data_1 = []
        let row_data_2 = []
        let row_data_3 = []
        let row_data_4 = []
        let row_data_5 = []
        let row_data_6 = []
        let row_data_7 = []
        let row_data_8 = []
        let row_data_9 = []
        let row_data_10 = []
        let row_data_11 = []

        row_data_0.push(["ETH/USDT", data[name + "eth_usdt"]])
        row_data_1.push(["USDT/ETH", data[name + "usdt_eth"]])
        row_data_2.push(["ETH/BTC", data[name + "eth_btc"]])
        row_data_3.push(["BTC/ETH", data[name + "btc_eth"]])
        row_data_4.push(["ETH/BNB", data[name + "eth_bnb"]])
        row_data_5.push(["BNB/ETH", data[name + "bnb_eth"]])
        row_data_6.push(["BTC/USDT", data[name + "btc_usdt"]])
        row_data_7.push(["USDT/BTC", data[name + "usdt_btc"]])
        row_data_8.push(["BTC/BNB", data[name + "btc_bnb"]])
        row_data_9.push(["BNB/BTC", data[name + "bnb_btc"]])
        row_data_10.push(["BNB/USDT", data[name + "bnb_usdt"]])
        row_data_11.push(["USDT/BNB", data[name + "usdt_bnb"]])

        // create a chart
        chart = anychart.line();
        var series0 = chart.line(row_data_0.map);
        var series1 = chart.line(row_data_1);
        var series2 = chart.line(row_data_2);
        var series3 = chart.line(row_data_3);
        var series4 = chart.line(row_data_4);
        var series5 = chart.line(row_data_5);
        var series6 = chart.line(row_data_6);
        var series7 = chart.line(row_data_7);
        var series8 = chart.line(row_data_8);
        var series9 = chart.line(row_data_9);
        var series10 = chart.line(row_data_10);
        var series11 = chart.line(row_data_11);

        // set the container id
        chart.container("transactions_line_chart");

        // initiate drawing the chart
        chart.draw();
    }

    function makeWealthDistributionPieChart(data) {
        let name = "wealth_distribution_"
        let row_data = []
        row_data.push(["MACD", data[name + 'macd']])
        row_data.push(["RSI", data[name + 'rsi']])
        row_data.push(["Moving Average", data[name + 'moving_average']])
        row_data.push(["Pivot Point", data[name + 'pivot_point']])

        var data = anychart.data.set(row_data);

        var series_0 = data.mapAs({x: 0, value: 1});

        // create a chart and set the data
        var chart = anychart.pie(series_0);

        // set the container id
        chart.container("distribution_pie_chart");
        chart.title("Wealth Distribution by Strategy pie chart")
        // initiate drawing the chart
        chart.draw();
    }

    // https://www.anychart.com/
    function makeWealthyAgentsBarChart(data) {
        row_data = []
        for (let i = 0; i < 10; i ++ ) {
            let name = "wealthy_" + i
            row_data.push([i + 1, data[name]["amount_in_usd"], data[name]["strategy"], data[name]['num_of_transactions'], data[name]['most_traded_currency_pair']])
        }
        var data = anychart.data.set(row_data);

        var series_0 = data.mapAs({x: 0, value: 1});

        // create a column chart
        var chart = anychart.column(series_0);

        var series = chart.getSeries(0);

        // disable the built-in tooltips
        series.tooltip(false);
        
        // set the selection mode to single
        chart.interactivity().selectionMode("single-select");
        
        var tooltip = document.getElementById("tooltip");

        /* show a custom tooltip
        when the mouse is over a column */
        chart.listen("pointMouseOver", function(e) {

        // show the tooltip
        tooltip.style.visibility = "visible"; 

        // set the text of the tooltip
        tooltip.innerHTML = "Amount in USD: "+ data.row(e.pointIndex)[1] + ", Strategy name: " + data.row(e.pointIndex)[2] +
                 ", Number of Transactions: "+ data.row(e.pointIndex)[3] + ", Most traded currency pair: "+ data.row(e.pointIndex)[4];
        });

        /* hide the custom tooltip
        when the mouse is out of a column */
        chart.listen("pointMouseOut", function() {
            tooltip.style.visibility = "hidden";
        });

        // set the position of custom tooltips
        chart.listen("mouseMove", function(e) {
            var clientX = e["offsetX"];
            var clientY = e["offsetY"];

            tooltip.style.left = clientX + 20 + "px";
            tooltip.style.top = clientY + 10 + "px";
            tooltip.style.zIndex = 10000;
            tooltip.style.border = "solid black 2px";
        });

        // set the chart title
        chart.title("Current Top 10 Wealthiest Agents");
        // draw
        chart.container("wealth_bar_chart");
        chart.draw();
    }


  </script>
</body>
</html>